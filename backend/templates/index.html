<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MVG Transport Display</title>
  <!-- Google Font (Nunito Sans) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link 
    href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" 
    rel="stylesheet"
  >

  <style>
    /*
       ------------------------------------------------
       Root Variables
       ------------------------------------------------
    */
    :root {
      /* General Colors */
      --bg-color: #f3f4f2;
      --text-color: #2f4f4f;
      --secondary-text: #6b8e23;

      /* Accent Colors */
      --line-box-color: #7c9a7b;
      --card-bg: #e6e9e5;

      /* Connection Colors */
      --connection-green: #6aa84f;
      --connection-yellow: #d1b05c;
      --connection-red: #cc6666;

      /* Shadows */
      --general-light-shadow: rgba(0, 0, 0, 0.15);
      --connection-none-shadow: rgba(0, 0, 0, 0.15);

      /* Transition Durations */
      --transition-duration: 0.4s;
    }

    /*
       ------------------------------------------------
       Dark Mode Overrides
       ------------------------------------------------
    */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #2f4f4f;
        --text-color: #e0f2e0;
        --secondary-text: #98fb98;
        --card-bg: #4b6b4b;

        --connection-none-shadow: rgba(255,255,255,0.1);
        --general-light-shadow: rgba(255,255,255,0.1);
      }
      .connection-none {
        box-shadow: 0px 4px 12px var(--connection-none-shadow);
      }
    }

    /*
       ------------------------------------------------
       Global Base Styles
       ------------------------------------------------
    */
    * {
      box-sizing: border-box;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Nunito Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
      transition: background-color var(--transition-duration) ease,
                  color var(--transition-duration) ease;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /*
       ------------------------------------------------
       Header + Station Name
       ------------------------------------------------
    */
    .header {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 32px;
    }
    .station-box {
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      background: linear-gradient(
        135deg,
        var(--card-bg) 0%,
        rgba(255,255,255,0) 100%
      );
      box-shadow: 0 2px 6px var(--general-light-shadow);
      transition: background var(--transition-duration) ease,
                  box-shadow var(--transition-duration) ease;
      cursor: pointer;
    }
    .station-name {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
      letter-spacing: 1px;
    }

    /*
       ------------------------------------------------
       Info Row (Date/Time + Weather)
       ------------------------------------------------
    */
    .info-row {
      display: flex;
      gap: 16px;
      width: 100%;
    }
    @media (max-width: 600px) {
      .info-row {
        flex-direction: column;
      }
    }
    .info-box {
      flex: 1;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      background: linear-gradient(
        135deg,
        var(--card-bg) 0%,
        rgba(255,255,255,0) 100%
      );
      box-shadow: 0px 4px 12px var(--general-light-shadow);
      transition: background var(--transition-duration) ease,
                  box-shadow var(--transition-duration) ease;
    }
    .datetime {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .date {
      color: var(--secondary-text);
      font-size: 1rem;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .weather-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .weather-temp {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .weather-icon {
      width: 3rem;
      height: 3rem;
      filter: drop-shadow(0px 3px 6px rgba(0, 0, 0, 0.4));
    }
    .weather-forecast {
      color: var(--secondary-text);
      font-size: 1rem;
      margin-top: 4px;
      font-weight: 600;
    }

    /*
       ------------------------------------------------
       Departures Section
       ------------------------------------------------
    */
    .direction-group {
      margin-bottom: 20px;
    }
    .direction-header {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 20px 0 10px 0;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .departures {
      display: flex;
      flex-direction: column;
    }

    /*
       ------------------------------------------------
       Departure Cards (No Animations)
       ------------------------------------------------
    */
    .departure-card {
      display: grid;
      grid-template-columns: 60px 1fr auto;
      gap: 20px;
      align-items: center;
      padding: 16px;
      border: none;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 12px;
      transition:
        background-color var(--transition-duration) ease,
        box-shadow var(--transition-duration) ease;
    }
    @media (prefers-color-scheme: dark) {
      .departure-card {
        background: #2f4f4f;
      }
    }
    .departure-card:hover {
      box-shadow: 0 6px 12px var(--general-light-shadow);
    }

    .line-number {
      background-color: var(--line-box-color);
      color: #fff;
      width: 60px;
      height: 60px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
    }
    .destination {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .minutes {
      font-size: 2rem;
      font-weight: 700;
      text-align: right;
    }

    /* Connection Status Coloring */
    .minutes.soon        { color: var(--connection-red); }
    .minutes.approaching { color: var(--connection-yellow); }
    .minutes.normal      { color: var(--connection-green); }

    /* Connection-based Drop Shadows */
    .connection-good {
      box-shadow: 0px 4px 8px rgba(34, 197, 94, 0.2);
    }
    .connection-medium {
      box-shadow: 0px 4px 8px rgba(252, 211, 77, 0.2);
    }
    .connection-poor {
      box-shadow: 0px 4px 8px rgba(248, 113, 113, 0.2);
    }
    .connection-none {
      box-shadow: 0px 4px 12px var(--general-light-shadow);
    }

    /*
       ------------------------------------------------
       Placeholders
       ------------------------------------------------
       We'll display these if the API returns fewer than 4 trams.
    */
    .placeholder {
      opacity: 0.6;
      font-style: italic;
      color: #999999;
      text-align: center;
    }

    /*
       ------------------------------------------------
       Last Updated
       ------------------------------------------------
    */
    .last-updated {
      text-align: center;
      color: var(--secondary-text);
      font-size: 0.9rem;
      margin-top: 20px;
    }
    .stale {
      color: var(--connection-red);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="station-box" id="station-toggle">
        <h1 class="station-name">PRINZ-EUGEN-PARK</h1>
      </div>
      <div class="info-row">
        <div class="info-box">
          <div class="datetime"></div>
          <div class="date"></div>
        </div>
        <div class="info-box">
          <div class="weather-info">
            <span class="weather-temp">--°C</span>
            <img class="weather-icon" src="" alt="Weather" />
          </div>
          <div class="weather-forecast">(↑--° ↓--°)</div>
        </div>
      </div>
    </div>

    <!-- Outward/Inbound Sections -->
    <div class="direction-group">
      <h2 class="direction-header" id="hdr-outward">Richtung Stadtauswärts</h2>
      <div class="departures" id="dep-outward"></div>
    </div>
    <div class="direction-group">
      <h2 class="direction-header" id="hdr-inward">Richtung Innenstadt</h2>
      <div class="departures" id="dep-inward"></div>
    </div>

    <div class="last-updated"></div>
  </div>

  <script>
    /*
       ------------------------------------------------
       GLOBAL VARIABLES / TRANSLATIONS
       ------------------------------------------------
    */
    let refreshTime = null;
    let language = 'DE';

    const WALKING_TIME = 6;

    // We'll store the currently displayed trams
    let outwardState = {};
    let inwardState  = {};

    const translations = {
      DE: {
        outward: "Richtung Stadtauswärts",
        inward: "Richtung Innenstadt",
        lastUpdated: "Letzte Aktualisierung vor",
        seconds: "Sekunden",
        errorLoading: "Fehler beim Laden der Daten.",
        placeholder: "Keine weitere Abfahrt"
      },
      EN: {
        outward: "Outbound",
        inward: "Inbound",
        lastUpdated: "Last updated",
        seconds: "seconds",
        errorLoading: "Error loading data.",
        placeholder: "No further departure"
      }
    };

    /*
       ------------------------------------------------
       DOM HELPERS
       ------------------------------------------------
    */
    const sel  = (id) => document.getElementById(id);
    const qsel = (s)  => document.querySelector(s);

    /*
       ------------------------------------------------
       TIME & DATE
       ------------------------------------------------
    */
    function formatDateTime() {
      const now = new Date();
      const locale = (language === 'DE') ? 'de-DE' : 'en-GB';

      const time = now.toLocaleTimeString(locale, {
        hour: '2-digit',
        minute: '2-digit'
      });
      const weekday = now.toLocaleDateString(locale, {
        weekday: 'long'
      });
      const date = now.toLocaleDateString(locale, {
        day: 'numeric',
        month: 'long'
      });

      qsel('.datetime').textContent = time;
      qsel('.date').textContent     = `${weekday}, ${date}`;
    }

    /*
       ------------------------------------------------
       LANGUAGE TOGGLE
       ------------------------------------------------
    */
    sel('station-toggle').addEventListener('click', () => {
      language = (language === 'DE') ? 'EN' : 'DE';
      sel('hdr-outward').textContent = translations[language].outward;
      sel('hdr-inward').textContent  = translations[language].inward;
      formatDateTime();
    });

    /*
       ------------------------------------------------
       WEATHER UPDATE
       ------------------------------------------------
    */
    function updateWeather(weather) {
      if (!weather) return;
      qsel('.weather-temp').textContent = `${weather.temp}°C`;
      qsel('.weather-forecast').textContent = `(↑${weather.temp_max}° ↓${weather.temp_min}°)`;
      const icon = qsel('.weather-icon');
      icon.src = `https://openweathermap.org/img/wn/${weather.icon}.png`;
      icon.alt = weather.description;
    }

    /*
       ------------------------------------------------
       TRAM HELPERS
       ------------------------------------------------
    */
    function getConnectionClass(connection) {
      if (!connection) return 'connection-none';
      return `connection-${connection.status}`;
    }
    function getMinuteColor(minutes) {
      if (minutes <= (WALKING_TIME - 1)) return 'soon';
      if (minutes <= (WALKING_TIME + 1)) return 'approaching';
      if (minutes <= (WALKING_TIME + 3)) return 'normal';
      return '';
    }

    // We'll use direction + index + line + destination for an ID
    // That way, we can do partial updates. 
    function getTramId(tram, i, directionKey) {
      return `${directionKey}-${i}-${tram.line}-${tram.destination}`;
    }

    /*
       ------------------------------------------------
       CARD CREATE / UPDATE / REMOVE
       ------------------------------------------------
    */
    function createTramCard(tram) {
      const card = document.createElement('div');
      card.className = `departure-card ${getConnectionClass(tram.connection)}`;
      card.innerHTML = `
        <div class="line-number">${tram.line}</div>
        <div class="destination">${tram.destination}</div>
        <div class="minutes ${getMinuteColor(tram.minutes)}">${tram.minutes}</div>
      `;
      return card;
    }

    // Create a "placeholder" card if fewer than 4 real trams
    // e.g. "No further departure"
    function createPlaceholderCard() {
      const card = document.createElement('div');
      card.className = 'departure-card connection-none';
      card.innerHTML = `
        <div class="line-number">--</div>
        <div class="destination placeholder">${translations[language].placeholder}</div>
        <div class="minutes">--</div>
      `;
      return card;
    }

    function updateTramCard(card, tram) {
      card.className = `departure-card ${getConnectionClass(tram.connection)}`;
      const minEl = card.querySelector('.minutes');
      minEl.className = `minutes ${getMinuteColor(tram.minutes)}`;
      minEl.textContent = tram.minutes;
      // If you'd like to also update the line/destination, do so:
      card.querySelector('.line-number').textContent = tram.line;
      card.querySelector('.destination').textContent  = tram.destination;
    }

    function removeTramCard(card) {
      card.remove();
    }

    /*
       ------------------------------------------------
       RENDER LOGIC (SHOW FOUR AT ALL TIMES)
       ------------------------------------------------
       - We want exactly 4 cards per direction.
       - If the API returns fewer, fill the remaining
         slots with placeholder cards.
       - If a tram has minutes=0, we still show it 
         because you specifically want 4 cards at all times.
    */
    function renderTrams(container, oldState, newTramsList, directionKey) {
      // newOrderIds => which IDs should remain
      const newOrderIds = [];

      // We'll force 4 total items
      for (let i = 0; i < 4; i++) {
        const tram = newTramsList[i];

        if (tram) {
          // Build a unique ID
          const id = getTramId(tram, i, directionKey);
          newOrderIds.push(id);

          // Create or update
          if (!oldState[id]) {
            const card = createTramCard(tram);
            container.appendChild(card);
            oldState[id] = { data: tram, cardElement: card };
          } else {
            // update
            updateTramCard(oldState[id].cardElement, tram);
          }
        } else {
          // No real tram => placeholder
          const id = `placeholder-${directionKey}-${i}`;
          newOrderIds.push(id);

          if (!oldState[id]) {
            // create placeholder
            const placeholder = createPlaceholderCard();
            container.appendChild(placeholder);
            oldState[id] = { data: null, cardElement: placeholder };
          } else {
            // If placeholder already exists, do nothing
          }
        }
      }

      // Re-append in correct order
      newOrderIds.forEach(id => {
        if (oldState[id]) {
          container.appendChild(oldState[id].cardElement);
        }
      });

      // Remove any old IDs not in newOrderIds
      for (const [id, obj] of Object.entries(oldState)) {
        if (!newOrderIds.includes(id)) {
          removeTramCard(obj.cardElement);
          delete oldState[id];
        }
      }
    }

    /*
       ------------------------------------------------
       MASTER UPDATE
       ------------------------------------------------
    */
    function updateDisplay(data) {
      if (!data) return;
      updateWeather(data.weather);
      formatDateTime();

      // Outward & inward arrays
      const outwardArr = data.trams.northbound;
      const inwardArr  = data.trams.southbound;

      // render outward
      renderTrams(sel('dep-outward'), outwardState, outwardArr, 'outward');

      // render inward
      renderTrams(sel('dep-inward'), inwardState, inwardArr, 'inward');

      refreshTime = Math.floor(Date.now() / 1000);
      qsel('.last-updated').textContent = 
        `${translations[language].lastUpdated} 0 ${translations[language].seconds}`;
    }

    /*
       ------------------------------------------------
       FETCH DATA
       ------------------------------------------------
    */
    async function fetchData() {
      try {
        const response = await fetch('/api/data');
        if (!response.ok) throw new Error(response.statusText);
        const data = await response.json();
        updateDisplay(data);
      } catch (error) {
        console.error(error);
        sel('dep-outward').textContent = translations[language].errorLoading;
        sel('dep-inward').textContent  = translations[language].errorLoading;
      }
    }

    /*
       ------------------------------------------------
       INTERVALS
       ------------------------------------------------
    */
    // Update Time/Date every second
    setInterval(() => {
      formatDateTime();
    }, 1000);

    // "Last Updated" every second
    setInterval(() => {
      if (!refreshTime) return;
      const now = Math.floor(Date.now() / 1000);
      const seconds = now - refreshTime;
      const lastUpdated = qsel('.last-updated');
      lastUpdated.textContent =
        `${translations[language].lastUpdated} ${seconds} ${translations[language].seconds}`;
      lastUpdated.classList.toggle('stale', seconds > 45);
    }, 1000);

    // Initial fetch + re-fetch every 15s
    fetchData();
    setInterval(fetchData, 15000);
  </script>
</body>
</html>